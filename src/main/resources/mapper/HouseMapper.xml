<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ssafy.bokduck.mapper.HouseMapper">

    <!-- House Info Result Map -->
    <resultMap id="HouseInfoResultMap" type="ssafy.bokduck.dto.HouseInfoDto">
        <id property="aptSeq" column="apt_seq"/>
        <result property="sggCd" column="sgg_cd"/>
        <result property="umdCd" column="umd_cd"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNmSggCd" column="road_nm_sgg_cd"/>
        <result property="roadNm" column="road_nm"/>
        <result property="roadNmBonbun" column="road_nm_bonbun"/>
        <result property="roadNmBubun" column="road_nm_bubun"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
    </resultMap>

    <!-- House Deal Result Map -->
    <resultMap id="HouseDealResultMap" type="ssafy.bokduck.dto.HouseDealDto">
        <id property="no" column="no"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="dealYear" column="deal_year"/>
        <result property="dealMonth" column="deal_month"/>
        <result property="dealDay" column="deal_day"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>
    </resultMap>
    
    <!-- Dong Code Result Map -->
    <resultMap id="DongCodeResultMap" type="ssafy.bokduck.dto.DongCodeDto">
        <id property="dongCode" column="dong_code"/>
        <result property="sidoName" column="sido_name"/>
        <result property="gugunName" column="gugun_name"/>
        <result property="dongName" column="dong_name"/>
    </resultMap>

    <!-- Find House Info by Apt Seq -->
    <select id="findHouseInfoByAptSeq" parameterType="string" resultMap="HouseInfoResultMap">
        SELECT *
        FROM houseinfos
        WHERE apt_seq = #{aptSeq}
    </select>

    <!-- Search House Infos -->
    <select id="searchHouseInfos" parameterType="map" resultMap="HouseInfoResultMap">
        SELECT *
        FROM houseinfos
        <where>
            <if test="dongCode != null and dongCode != ''">
                AND umd_cd = #{dongCode}
            </if>
            <if test="aptName != null and aptName != ''">
                AND apt_nm LIKE CONCAT('%', #{aptName}, '%')
            </if>
        </where>
    </select>

    <!-- Find Deals by Apt Seq -->
    <select id="findDealsByAptSeq" parameterType="string" resultMap="HouseDealResultMap">
        SELECT *
        FROM housedeals
        WHERE apt_seq = #{aptSeq}
        ORDER BY deal_year DESC, deal_month DESC, deal_day DESC
    </select>
    
    <!-- Search Dong Codes -->
    <select id="searchDongCodes" parameterType="string" resultMap="DongCodeResultMap">
        SELECT *
        FROM dongcodes
        WHERE dong_name LIKE CONCAT('%', #{dongName}, '%')
    </select>

    <!-- Scraps -->
    <insert id="insertScrap" parameterType="ssafy.bokduck.dto.PropertyScrapDto">
        INSERT INTO property_scraps (user_id, apt_seq, created_at)
        VALUES (#{userId}, #{aptSeq}, NOW())
    </insert>

    <delete id="deleteScrap">
        DELETE FROM property_scraps
        WHERE user_id = #{userId} AND apt_seq = #{aptSeq}
    </delete>

    <select id="checkScrap" resultType="int">
        SELECT COUNT(*)
        FROM property_scraps
        WHERE user_id = #{userId} AND apt_seq = #{aptSeq}
    </select>

    <select id="findScrappedHouses" parameterType="long" resultMap="HouseInfoResultMap">
        SELECT h.*
        FROM houseinfos h
        JOIN property_scraps ps ON h.apt_seq = ps.apt_seq
        WHERE ps.user_id = #{userId}
    </select>

</mapper>
