<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ssafy.bokduck.mapper.HouseMapper">

    <!-- House Info Result Map -->
    <resultMap id="HouseInfoResultMap" type="ssafy.bokduck.dto.HouseInfoDto">
        <id property="aptSeq" column="apt_seq"/>
        <result property="sggCd" column="sgg_cd"/>
        <result property="umdCd" column="umd_cd"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNmSggCd" column="road_nm_sgg_cd"/>
        <result property="roadNm" column="road_nm"/>
        <result property="roadNmBonbun" column="road_nm_bonbun"/>
        <result property="roadNmBubun" column="road_nm_bubun"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="latestDealAmount" column="latest_deal_amount" jdbcType="VARCHAR"/>
        <result property="latestDealYear" column="latest_deal_year" jdbcType="INTEGER"/>
        <result property="latestDealMonth" column="latest_deal_month" jdbcType="INTEGER"/>
        <result property="latestDealDay" column="latest_deal_day" jdbcType="INTEGER"/>
        <result property="latestDealFloor" column="latest_deal_floor" jdbcType="VARCHAR"/>
        <result property="latestDealArea" column="latest_deal_area" jdbcType="DECIMAL"/>
    </resultMap>

    <!-- House Deal Result Map -->
    <resultMap id="HouseDealResultMap" type="ssafy.bokduck.dto.HouseDealDto">
        <id property="no" column="no"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="dealYear" column="deal_year"/>
        <result property="dealMonth" column="deal_month"/>
        <result property="dealDay" column="deal_day"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>
    </resultMap>
    
    <!-- Dong Code Result Map -->
    <resultMap id="DongCodeResultMap" type="ssafy.bokduck.dto.DongCodeDto">
        <id property="dongCode" column="dong_code"/>
        <result property="sidoName" column="sido_name"/>
        <result property="gugunName" column="gugun_name"/>
        <result property="dongName" column="dong_name"/>
    </resultMap>

    <!-- Find House Info by Apt Seq -->
    <select id="findHouseInfoByAptSeq" parameterType="string" resultMap="HouseInfoResultMap">
        SELECT *
        FROM houseinfos
        WHERE apt_seq = #{aptSeq}
    </select>

    <!-- Search House Infos -->
    <select id="searchHouseInfos" parameterType="map" resultMap="HouseInfoResultMap">
        SELECT 
            h.apt_seq,
            h.sgg_cd,
            h.umd_cd,
            h.umd_nm,
            h.jibun,
            h.road_nm_sgg_cd,
            h.road_nm,
            h.road_nm_bonbun,
            h.road_nm_bubun,
            h.apt_nm,
            h.build_year,
            h.latitude,
            h.longitude,
            d.deal_amount as latest_deal_amount,
            d.deal_year as latest_deal_year,
            d.deal_month as latest_deal_month,
            d.deal_day as latest_deal_day,
            d.floor as latest_deal_floor,
            d.exclu_use_ar as latest_deal_area
        FROM houseinfos h
        LEFT JOIN (
            SELECT hd1.apt_seq,
                   hd1.deal_amount,
                   hd1.deal_year,
                   hd1.deal_month,
                   hd1.deal_day,
                   hd1.floor,
                   hd1.exclu_use_ar
            FROM housedeals hd1
            INNER JOIN (
                SELECT apt_seq, MAX(no) as max_no
                FROM housedeals
                GROUP BY apt_seq
            ) hd2 ON hd1.apt_seq = hd2.apt_seq AND hd1.no = hd2.max_no
        ) d ON h.apt_seq = d.apt_seq
        <where>
            <!-- ðŸ”¥ ì§€ì—­ í•„í„°ë§: íŠœí”Œ ë§¤ì¹­ë§Œ ì‚¬ìš© (dongName í´ë°± ì™„ì „ ì œê±°) -->
            <if test="sggUmdPairs != null and sggUmdPairs.size() > 0">
            AND h.sgg_cd IS NOT NULL 
            AND h.umd_cd IS NOT NULL 
            AND (h.sgg_cd, h.umd_cd) IN
            <foreach collection="sggUmdPairs" item="pair" open="(" separator="," close=")">
                (#{pair.sggCd}, #{pair.umdCd})
            </foreach>
            </if>
            <!-- umdNmë§Œ ìžˆê³  sidoName/gugunNameì´ ì—†ì„ ë•Œë§Œ WHERE ì ˆì—ì„œ í•„í„°ë§ (JOIN ì—†ì´) -->
            <if test="umdNm != null and umdNm != '' and (sidoName == null or sidoName == '') and (gugunName == null or gugunName == '')">
                AND h.umd_nm LIKE CONCAT('%', #{umdNm}, '%')
            </if>
            <if test="aptName != null and aptName != ''">
                AND h.apt_nm LIKE CONCAT('%', #{aptName}, '%')
            </if>
            <if test="minPrice != null and minPrice > 0">
                AND d.deal_amount IS NOT NULL
                AND CAST(REPLACE(d.deal_amount, ',', '') AS UNSIGNED) >= #{minPrice}
            </if>
            <if test="maxPrice != null and maxPrice > 0">
                AND d.deal_amount IS NOT NULL
                AND CAST(REPLACE(d.deal_amount, ',', '') AS UNSIGNED) &lt;= #{maxPrice}
            </if>
            <if test="minArea != null and minArea > 0">
                AND d.exclu_use_ar IS NOT NULL
                AND d.exclu_use_ar >= #{minArea}
            </if>
            <if test="maxArea != null and maxArea > 0">
                AND d.exclu_use_ar IS NOT NULL
                AND d.exclu_use_ar &lt;= #{maxArea}
            </if>
            <if test="sggCd != null and sggCd != ''">
                AND h.sgg_cd = #{sggCd}
            </if>
        </where>
        ORDER BY h.apt_seq DESC
        <if test="limit != null and limit > 0">
            LIMIT ${limit}
        </if>
    </select>

    <!-- Count House Infos -->
    <select id="countHouseInfos" parameterType="map" resultType="int">
        SELECT COUNT(DISTINCT h.apt_seq)
        FROM houseinfos h
        LEFT JOIN (
            SELECT hd1.apt_seq,
                   hd1.deal_amount,
                   hd1.exclu_use_ar
            FROM housedeals hd1
            INNER JOIN (
                SELECT apt_seq, MAX(no) as max_no
                FROM housedeals
                GROUP BY apt_seq
            ) hd2 ON hd1.apt_seq = hd2.apt_seq AND hd1.no = hd2.max_no
        ) d ON h.apt_seq = d.apt_seq
        <where>
            <!-- ðŸ”¥ ì§€ì—­ í•„í„°ë§: íŠœí”Œ ë§¤ì¹­ë§Œ ì‚¬ìš© (dongName í´ë°± ì™„ì „ ì œê±°) -->
            <if test="sggUmdPairs != null and sggUmdPairs.size() > 0">
            AND h.sgg_cd IS NOT NULL 
            AND h.umd_cd IS NOT NULL 
            AND (h.sgg_cd, h.umd_cd) IN
            <foreach collection="sggUmdPairs" item="pair" open="(" separator="," close=")">
                (#{pair.sggCd}, #{pair.umdCd})
            </foreach>
            </if>
            <!-- umdNmë§Œ ìžˆê³  sidoName/gugunNameì´ ì—†ì„ ë•Œë§Œ WHERE ì ˆì—ì„œ í•„í„°ë§ (JOIN ì—†ì´) -->
            <if test="umdNm != null and umdNm != '' and (sidoName == null or sidoName == '') and (gugunName == null or gugunName == '')">
                AND h.umd_nm LIKE CONCAT('%', #{umdNm}, '%')
            </if>
            <if test="aptName != null and aptName != ''">
                AND h.apt_nm LIKE CONCAT('%', #{aptName}, '%')
            </if>
            <if test="minPrice != null and minPrice > 0">
                AND d.deal_amount IS NOT NULL
                AND CAST(REPLACE(d.deal_amount, ',', '') AS UNSIGNED) >= #{minPrice}
            </if>
            <if test="maxPrice != null and maxPrice > 0">
                AND d.deal_amount IS NOT NULL
                AND CAST(REPLACE(d.deal_amount, ',', '') AS UNSIGNED) &lt;= #{maxPrice}
            </if>
            <if test="minArea != null and minArea > 0">
                AND d.exclu_use_ar IS NOT NULL
                AND d.exclu_use_ar >= #{minArea}
            </if>
            <if test="maxArea != null and maxArea > 0">
                AND d.exclu_use_ar IS NOT NULL
                AND d.exclu_use_ar &lt;= #{maxArea}
            </if>
            <if test="sggCd != null and sggCd != ''">
                AND h.sgg_cd = #{sggCd}
            </if>
        </where>
    </select>

    <!-- Find Deals by Apt Seq -->
    <select id="findDealsByAptSeq" parameterType="string" resultMap="HouseDealResultMap">
        SELECT *
        FROM housedeals
        WHERE apt_seq = #{aptSeq}
        ORDER BY deal_year DESC, deal_month DESC, deal_day DESC
    </select>
    
    <!-- Search Dong Codes -->
    <select id="searchDongCodes" parameterType="string" resultMap="DongCodeResultMap">
        SELECT *
        FROM dongcodes
        WHERE dong_name LIKE CONCAT('%', #{dongName}, '%')
           OR gugun_name LIKE CONCAT('%', #{dongName}, '%') 
           OR sido_name LIKE CONCAT('%', #{dongName}, '%')
    </select>
    
    <!-- Get Sido Names (ì‹œ/ë„ ëª©ë¡) -->
    <select id="getSidoNames" resultType="string">
        SELECT DISTINCT sido_name
        FROM dongcodes
        WHERE sido_name IS NOT NULL AND sido_name != ''
        ORDER BY sido_name
    </select>
    
    <!-- Get Gugun Names (ì‹œ/êµ°/êµ¬ ëª©ë¡) - ì „ì²´ ë˜ëŠ” ì‹œ/ë„ë¡œ í•„í„°ë§ -->
    <select id="getGugunNames" resultType="string">
        SELECT DISTINCT gugun_name
        FROM dongcodes
        WHERE gugun_name IS NOT NULL AND gugun_name != ''
        <if test="sidoName != null and sidoName != ''">
        AND sido_name = #{sidoName}
        </if>
        ORDER BY gugun_name
    </select>
    
    <!-- Get Dongs by Sido and Gugun (íŠ¹ì • ì‹œ/ë„ì™€ ì‹œ/êµ°/êµ¬ì˜ ì/ë©´/ë™ ëª©ë¡) -->
    <select id="getDongsBySidoAndGugun" resultMap="DongCodeResultMap">
        SELECT DISTINCT dong_code, sido_name, gugun_name, dong_name
        FROM dongcodes
        WHERE gugun_name = #{gugunName}
        <if test="sidoName != null and sidoName != ''">
        AND sido_name = #{sidoName}
        </if>
        AND dong_name IS NOT NULL AND dong_name != ''
        ORDER BY dong_name
    </select>
    
    <!-- Get Dongs by Gugun (ê¸°ì¡´ ë©”ì„œë“œ - í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€) -->
    <select id="getDongsByGugun" parameterType="string" resultMap="DongCodeResultMap">
        SELECT DISTINCT dong_code, sido_name, gugun_name, dong_name
        FROM dongcodes
        WHERE gugun_name = #{gugunName}
        AND dong_name IS NOT NULL AND dong_name != ''
        ORDER BY dong_name
    </select>
    
    <!-- Get Dong Codes by Sido (íŠ¹ì • ì‹œ/ë„ì˜ ëª¨ë“  dong_code ëª©ë¡ ì¡°íšŒ) -->
    <select id="getDongCodesBySido" resultMap="DongCodeResultMap">
        SELECT DISTINCT dong_code, sido_name, gugun_name, dong_name
        FROM dongcodes
        WHERE sido_name = #{sidoName}
        AND dong_code IS NOT NULL AND dong_code != ''
        ORDER BY dong_code
    </select>
    
    <!-- Scraps -->
    <insert id="insertScrap" parameterType="ssafy.bokduck.dto.PropertyScrapDto">
        INSERT INTO property_scraps (user_id, apt_seq, created_at)
        VALUES (#{userId}, #{aptSeq}, NOW())
    </insert>

    <delete id="deleteScrap">
        DELETE FROM property_scraps
        WHERE user_id = #{userId} AND apt_seq = #{aptSeq}
    </delete>

    <select id="checkScrap" resultType="int">
        SELECT COUNT(*)
        FROM property_scraps
        WHERE user_id = #{userId} AND apt_seq = #{aptSeq}
    </select>

    <select id="findScrappedHouses" parameterType="long" resultMap="HouseInfoResultMap">
        SELECT h.*
        FROM houseinfos h
        INNER JOIN property_scraps ps ON h.apt_seq = ps.apt_seq
        WHERE ps.user_id = #{userId}
        ORDER BY ps.created_at DESC
    </select>

</mapper>
